{% extends 'base.html' %}
{% block title %}{{ inv.invoice_number }} — Dex Inv{% endblock %}
{% block pagetitle %}{{ inv.invoice_number }}{% endblock %}
{% block breadcrumb %}dex-inv / billing / {{ inv.invoice_number }}{% endblock %}

{% block head %}
<style>
  .invoice-doc{
    background:var(--surface);border:1px solid var(--border);border-radius:14px;
    max-width:820px;margin:0 auto;overflow:hidden;
    animation:pageIn .4s ease both;
    box-shadow:0 12px 48px rgba(0,0,0,.35);
  }
  .inv-header{
    background:linear-gradient(135deg,#0e1117 0%,#141920 100%);
    padding:36px 40px;border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:flex-start;
    position:relative;overflow:hidden;
  }
  .inv-header::after{
    content:'';position:absolute;right:-60px;top:-60px;
    width:220px;height:220px;border-radius:50%;
    background:radial-gradient(circle,rgba(6,214,160,.08) 0%,transparent 70%);
  }
  .inv-logo{display:flex;align-items:center;gap:12px;}
  .inv-logo-mark{width:44px;height:44px;background:var(--accent);border-radius:10px;
    display:flex;align-items:center;justify-content:center;
    font-family:var(--font-display);font-weight:800;font-size:20px;color:#000;}
  .inv-logo-text{font-family:var(--font-display);font-size:22px;font-weight:700;}
  .inv-logo-text span{color:var(--accent);}
  .inv-number{text-align:right;}
  .inv-number .num{font-family:var(--font-mono);font-size:22px;font-weight:600;color:var(--accent);}
  .inv-number .date{font-size:12px;color:var(--muted2);margin-top:4px;font-family:var(--font-mono);}

  .inv-body{padding:36px 40px;}
  .inv-parties{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-bottom:36px;}
  .party-label{font-size:10px;color:var(--muted);font-family:var(--font-mono);
    letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;}
  .party-name{font-family:var(--font-display);font-size:16px;font-weight:700;margin-bottom:4px;}
  .party-detail{font-size:13px;color:var(--muted2);line-height:1.6;}

  .inv-meta{display:flex;gap:20px;margin-bottom:32px;flex-wrap:wrap;}
  .meta-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;
    padding:12px 16px;flex:1;min-width:120px;}
  .meta-label{font-size:10px;color:var(--muted);font-family:var(--font-mono);letter-spacing:1px;
    text-transform:uppercase;margin-bottom:4px;}
  .meta-value{font-family:var(--font-mono);font-size:14px;font-weight:600;}

  /* Line items table */
  .inv-table{width:100%;border-collapse:collapse;margin-bottom:28px;}
  .inv-table th{font-family:var(--font-mono);font-size:10px;letter-spacing:1.5px;
    text-transform:uppercase;color:var(--muted);padding:10px 14px;
    border-bottom:2px solid var(--border);text-align:left;}
  .inv-table th:last-child,.inv-table td:last-child{text-align:right;}
  .inv-table td{padding:13px 14px;border-bottom:1px solid rgba(29,38,56,.6);font-size:14px;}
  .inv-table tr:last-child td{border-bottom:none;}
  .inv-table tbody tr:hover{background:rgba(255,255,255,.02);}

  .totals-area{display:flex;justify-content:flex-end;margin-bottom:28px;}
  .totals-box{min-width:280px;}
  .total-row{display:flex;justify-content:space-between;padding:8px 0;font-size:13px;color:var(--muted2);}
  .total-row.grand{border-top:1px solid var(--border);margin-top:8px;padding-top:14px;}
  .total-row.grand span:first-child{font-family:var(--font-display);font-size:16px;font-weight:700;color:var(--text);}
  .total-row.grand span:last-child{font-family:var(--font-mono);font-size:20px;font-weight:700;color:var(--accent);}

  .inv-notes{background:var(--surface2);border:1px solid var(--border);border-radius:8px;
    padding:14px 18px;margin-bottom:28px;}
  .inv-notes-label{font-size:10px;color:var(--muted);font-family:var(--font-mono);
    letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;}
  .inv-notes-text{font-size:13px;color:var(--muted2);line-height:1.6;}

  .inv-footer{
    border-top:1px solid var(--border);padding:16px 40px;
    display:flex;align-items:center;justify-content:space-between;
    font-family:var(--font-mono);font-size:10px;color:var(--muted);
  }

  .status-bar{
    display:flex;align-items:center;justify-content:space-between;
    padding:14px 40px;background:var(--surface2);border-bottom:1px solid var(--border);
  }

  @media print {
    #sidebar,#topbar,.topbar,.app-footer,.action-bar,nav,footer{display:none!important}
    #main{width:100%!important}
    .invoice-doc{border:none;box-shadow:none;max-width:100%;}
    body{background:#fff;color:#000;}
    .inv-header,.inv-body,.inv-footer,.inv-notes,.status-bar{background:#fff!important;color:#000!important;}
    .inv-table td,.inv-table th{color:#000!important;border-color:#ddd!important;}
    .inv-logo-text span,.inv-number .num,.total-row.grand span:last-child,.meta-value{color:#000!important;}
    .party-label,.meta-label,.inv-notes-label{color:#666!important;}
    .party-detail,.total-row,.inv-notes-text,.inv-footer,.topbar-path,.status-bar{color:#444!important;}
  }
</style>
{% endblock %}

{% block content %}

<!-- Action Bar -->
<div class="action-bar d-flex align-items-center justify-content-between mb-4" style="animation:pageIn .35s ease both">
  <a href="/invoices" class="btn-ghost-dex"><i class="bi bi-arrow-left"></i>Back to Invoices</a>
  <div class="d-flex gap-2 align-items-center">
    <!-- Status update -->
    <form method="POST" action="/invoices/{{ inv.id }}/status" class="d-flex gap-2 align-items-center">
      <select class="form-select" name="status" style="width:140px;font-size:13px">
        <option value="draft"     {% if inv.status=='draft'     %}selected{% endif %}>Draft</option>
        <option value="sent"      {% if inv.status=='sent'      %}selected{% endif %}>Sent</option>
        <option value="paid"      {% if inv.status=='paid'      %}selected{% endif %}>Paid</option>
        <option value="cancelled" {% if inv.status=='cancelled' %}selected{% endif %}>Cancelled</option>
      </select>
      <button class="btn-primary-dex" type="submit"><i class="bi bi-check2"></i>Update</button>
    </form>
    <button class="btn-ghost-dex" onclick="window.print()"><i class="bi bi-printer"></i>Print</button>
  </div>
</div>

<!-- INVOICE DOCUMENT -->
<div class="invoice-doc">
  <!-- Status -->
  <div class="status-bar">
    <div style="font-family:var(--font-mono);font-size:11px;color:var(--muted2)">INVOICE STATUS</div>
    {% if inv.status == 'paid' %}
      <span class="chip chip-green" style="font-size:12px;padding:4px 14px">✓ PAID</span>
    {% elif inv.status == 'sent' %}
      <span class="chip chip-yellow" style="font-size:12px;padding:4px 14px">→ SENT</span>
    {% elif inv.status == 'cancelled' %}
      <span class="chip chip-red" style="font-size:12px;padding:4px 14px">✕ CANCELLED</span>
    {% else %}
      <span class="chip chip-gray" style="font-size:12px;padding:4px 14px">◌ DRAFT</span>
    {% endif %}
  </div>

  <!-- Header -->
  <div class="inv-header">
    <div class="inv-logo">
      <div class="inv-logo-mark">D</div>
      <div>
        <div class="inv-logo-text">Dex <span>Inv</span></div>
        <div style="font-size:10px;color:var(--muted2);font-family:var(--font-mono);letter-spacing:1.5px">INVENTORY OS</div>
      </div>
    </div>
    <div class="inv-number">
      <div class="num">{{ inv.invoice_number }}</div>
      <div class="date">Issued {{ inv.created_at[:10] if inv.created_at else '—' }}</div>
      {% if inv.due_date %}<div class="date">Due {{ inv.due_date }}</div>{% endif %}
    </div>
  </div>

  <div class="inv-body">
    <!-- Parties -->
    <div class="inv-parties">
      <div>
        <div class="party-label">From</div>
        <div class="party-name">{{ inv.comp_name or 'Dex Inv' }}</div>
        <div class="party-detail">
          {{ inv.comp_address or '' }}{% if inv.city %}, {{ inv.city }}{% endif %}{% if inv.state %}, {{ inv.state }}{% endif %}{% if inv.zip %} {{ inv.zip }}{% endif %}<br>
          {% if inv.comp_email %}{{ inv.comp_email }}{% endif %}
        </div>
      </div>
      <div>
        <div class="party-label">Billed To</div>
        <div class="party-name">{{ inv.billed_to or '—' }}</div>
        <div class="party-detail">{{ inv.billed_to_address or '' }}</div>
      </div>
    </div>

    <!-- Meta -->
    <div class="inv-meta">
      <div class="meta-box">
        <div class="meta-label">Invoice #</div>
        <div class="meta-value">{{ inv.invoice_number }}</div>
      </div>
      <div class="meta-box">
        <div class="meta-label">Issue Date</div>
        <div class="meta-value">{{ inv.created_at[:10] if inv.created_at else '—' }}</div>
      </div>
      {% if inv.due_date %}
      <div class="meta-box">
        <div class="meta-label">Due Date</div>
        <div class="meta-value">{{ inv.due_date }}</div>
      </div>
      {% endif %}
      <div class="meta-box">
        <div class="meta-label">Status</div>
        <div class="meta-value" style="color:{% if inv.status=='paid' %}#06d6a0{% elif inv.status=='sent' %}#ffd166{% elif inv.status=='cancelled' %}#ff4d6d{% else %}var(--muted2){% endif %}">
          {{ inv.status.upper() }}
        </div>
      </div>
    </div>

    <!-- Line items -->
    <table class="inv-table">
      <thead><tr>
        <th>#</th><th>Description</th><th style="text-align:right">Qty</th>
        <th style="text-align:right">Unit Price</th><th>Total</th>
      </tr></thead>
      <tbody>
        {% for item in items %}
        <tr>
          <td style="font-family:var(--font-mono);font-size:11px;color:var(--muted2)">{{ loop.index }}</td>
          <td style="font-weight:500">{{ item.description }}</td>
          <td style="text-align:right;font-family:var(--font-mono)">{{ item.quantity }}</td>
          <td style="text-align:right;font-family:var(--font-mono)">${{ '%.2f'|format(item.unit_price) }}</td>
          <td style="font-family:var(--font-mono);font-weight:600">${{ '%.2f'|format(item.total) }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted2)">No line items</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Totals -->
    <div class="totals-area">
      <div class="totals-box">
        <div class="total-row">
          <span>Subtotal</span>
          <span style="font-family:var(--font-mono)">${{ '%.2f'|format(inv.subtotal) }}</span>
        </div>
        {% if inv.tax_rate > 0 %}
        <div class="total-row">
          <span>Tax ({{ inv.tax_rate }}%)</span>
          <span style="font-family:var(--font-mono)">${{ '%.2f'|format(inv.total - inv.subtotal) }}</span>
        </div>
        {% endif %}
        <div class="total-row grand">
          <span>Total</span>
          <span>${{ '%.2f'|format(inv.total) }}</span>
        </div>
      </div>
    </div>

    <!-- Notes -->
    {% if inv.notes %}
    <div class="inv-notes">
      <div class="inv-notes-label">Notes</div>
      <div class="inv-notes-text">{{ inv.notes }}</div>
    </div>
    {% endif %}
  </div>

  <div class="inv-footer">
    <span>Dex Inv · Smart Inventory OS</span>
    <span>Generated {{ inv.created_at[:10] if inv.created_at else '' }} · @dex.asm</span>
  </div>
</div>
{% endblock %}
